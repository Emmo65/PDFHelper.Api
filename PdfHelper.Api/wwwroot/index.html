<!doctype html>
<html lang="de" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <title>PDF Helper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="brand">
      <svg class="logo" viewBox="0 0 120 120" aria-hidden="true">
        <circle class="ring" cx="60" cy="60" r="48"/>
        <path class="spinner" d="M60 12 A48 48 0 0 1 108 60" stroke="url(#g)" stroke-width="10" fill="none" stroke-linecap="round"/>
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#6ae2ff"/><stop offset="100%" stop-color="#8f7aff"/>
          </linearGradient>
        </defs>
      </svg>
      <h1>PDF Helper</h1>
    </div>
    <button id="themeBtn" class="btn ghost" type="button">ðŸŒ— Theme</button>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- Merge -->
      <section class="card">
        <div class="badge">Merge</div>
        <h2>PDFs zusammenfÃ¼hren</h2>
        <div class="row" style="flex-wrap:nowrap; gap:16px;">
          <label class="dropzone" id="dz-merge" style="flex:1">
            <input type="file" id="mergeFiles" multiple accept="application/pdf">
            <span></span>
          </label>
          <button class="btn primary" onclick="merge()">ZusammenfÃ¼hren</button>
        </div>
        <p class="muted">Mindestens 2 PDFs auswÃ¤hlen. Ergebnis: <code>merged.pdf</code></p>
      </section>

      <!-- Split -->
      <section class="card">
        <div class="badge">Split</div>
        <h2>PDF aufteilen</h2>
        <div class="row" style="flex-wrap:wrap; gap:12px;">
          <label class="dropzone" id="dz-split" style="flex:1; min-width:320px">
            <input type="file" id="splitFile" accept="application/pdf">
            <span></span>
          </label>
          <input class="input" id="splitRanges" placeholder="Bereiche z. B. 1-3,5,8-end">
          <button class="btn primary" onclick="split()">Aufteilen</button>
        </div>
        <p class="muted">Ergebnis: ZIP mit Teil-PDFs (<code>parts.zip</code>)</p>
      </section>

      <!-- Rotate -->
      <section class="card">
        <div class="badge">Rotate</div>
        <h2>Seiten drehen</h2>
        <div class="row" style="flex-wrap:wrap; gap:12px;">
          <label class="dropzone" id="dz-rot" style="flex:1; min-width:320px">
            <input type="file" id="rotFile" accept="application/pdf">
            <span></span>
          </label>
          <input class="input" id="rotPages" placeholder="Seiten z. B. 2,4-5">
          <select class="input" id="rotAngle">
            <option value="90">90Â°</option>
            <option value="180">180Â°</option>
            <option value="270">270Â°</option>
          </select>
          <button class="btn primary" onclick="rotate()">Drehen</button>
        </div>
        <p class="muted">Ergebnis: <code>rotated.pdf</code></p>
      </section>

      <!-- Compress -->
      <section class="card">
        <div class="badge">Compress</div>
        <h2>PDF komprimieren</h2>
        <div class="row" style="flex-wrap:wrap; gap:12px;">
          <label class="dropzone" id="dz-cmp" style="flex:1; min-width:320px">
            <input type="file" id="cmpFile" accept="application/pdf">
            <span></span>
          </label>
          <select class="input" id="cmpLevel">
            <option value="standard">standard (/ebook)</option>
            <option value="low">low (/screen)</option>
            <option value="high">high (/prepress)</option>
          </select>
          <button class="btn primary" onclick="compress()">Komprimieren</button>
        </div>
        <p class="muted">BenÃ¶tigt Ghostscript. Ergebnis: <code>compressed.pdf</code></p>
      </section>

      <!-- Text ersetzen -->
      <section class="card">
        <div class="badge">Text</div>
        <h2>Text ersetzen (Overlay)</h2>
        <div class="row" style="flex-direction:column; align-items:flex-start; gap:12px;">
          <label class="dropzone" id="dz-rep" style="width:100%; max-width:480px">
            <input type="file" id="repFile" accept="application/pdf">
            <span></span>
          </label>
          <div class="row">
            <input class="input" id="repFind" placeholder="Suche (z. B. Muster)">
            <input class="input" id="repReplace" placeholder="Ersetzen durch">
          </div>
          <div class="row">
            <label><input type="checkbox" id="repCase"> GroÃŸ/Klein beachten</label>
            <label><input type="checkbox" id="repWhole" checked> Ganzes Wort</label>
            <button class="btn primary" onclick="replaceText()">Ersetzen</button>
          </div>
        </div>
        <p class="muted">Ergebnis: <code>text-replaced.pdf</code></p>
      </section>

      <!-- Text schwÃ¤rzen -->
      <section class="card">
        <div class="badge">Redact</div>
        <h2>Text schwÃ¤rzen</h2>
        <div class="row" style="flex-direction:column; align-items:flex-start; gap:12px;">
          <label class="dropzone" id="dz-red" style="width:100%; max-width:480px">
            <input type="file" id="redFile" accept="application/pdf">
            <span></span>
          </label>
          <div class="row">
            <input class="input" id="redFind" placeholder="Suche (z. B. IBAN)">
          </div>
          <div class="row">
            <label><input type="checkbox" id="redCase"> GroÃŸ/Klein beachten</label>
            <label><input type="checkbox" id="redWhole" checked> Ganzes Wort</label>
            <button class="btn primary" onclick="redactText()">SchwÃ¤rzen</button>
          </div>
        </div>
        <p class="muted">Ergebnis: <code>text-redacted.pdf</code></p>
      </section>
    </div>
  </div>

  <div id="toast" class="toast">Fertig.</div>

  <script>
    // Light/Dark Toggle
    const themeBtn = document.getElementById('themeBtn');
    themeBtn.addEventListener('click', () => {
      const html = document.documentElement;
      html.setAttribute('data-theme', html.getAttribute('data-theme') === 'light' ? 'dark' : 'light');
    });

    // Toast helper
    function showToast(msg){
      const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'),2000);
    }

    async function downloadFromResponse(res, filename){
      if(!res.ok){
        try{ const err = await res.json(); alert(err.message || "Fehler"); }
        catch{ alert("Fehler"); }
        return;
      }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
      showToast('Download gestartet');
    }

    async function merge(){
      const inp = document.getElementById('mergeFiles');
      const fd = new FormData();
      [...inp.files].forEach(f => fd.append('files', f));
      const res = await fetch('/api/merge', { method:'POST', body: fd });
      await downloadFromResponse(res, 'merged.pdf');
    }

    async function split(){
      const file = document.getElementById('splitFile').files[0];
      const ranges = document.getElementById('splitRanges').value;
      const fd = new FormData(); if(file) fd.append('file', file);
      const res = await fetch(`/api/split?ranges=${encodeURIComponent(ranges)}`, { method:'POST', body: fd });
      await downloadFromResponse(res, 'parts.zip');
    }

    async function rotate(){
      const file = document.getElementById('rotFile').files[0];
      const pages = document.getElementById('rotPages').value;
      const angle = document.getElementById('rotAngle').value;
      const fd = new FormData(); if(file) fd.append('file', file);
      const res = await fetch(`/api/rotate?pages=${encodeURIComponent(pages)}&angle=${encodeURIComponent(angle)}`, { method:'POST', body: fd });
      await downloadFromResponse(res, 'rotated.pdf');
    }

    async function compress(){
      const file = document.getElementById('cmpFile').files[0];
      const level = document.getElementById('cmpLevel').value;
      const fd = new FormData(); if(file) fd.append('file', file);
      const res = await fetch(`/api/compress?level=${encodeURIComponent(level)}`, { method:'POST', body: fd });
      await downloadFromResponse(res, 'compressed.pdf');
    }

    async function replaceText(){
      const file = document.getElementById('repFile').files[0];
      const find = document.getElementById('repFind').value;
      const repl = document.getElementById('repReplace').value;
      const matchCase = document.getElementById('repCase').checked;
      const wholeWord = document.getElementById('repWhole').checked;
      const fd = new FormData(); if(file) fd.append('file', file);
      const url = `/api/text/replace?find=${encodeURIComponent(find)}&replace=${encodeURIComponent(repl)}&matchCase=${matchCase}&wholeWord=${wholeWord}`;
      const res = await fetch(url, { method:'POST', body: fd });
      await downloadFromResponse(res, 'text-replaced.pdf');
    }

    async function redactText(){
      const file = document.getElementById('redFile').files[0];
      const find = document.getElementById('redFind').value;
      const matchCase = document.getElementById('redCase').checked;
      const wholeWord = document.getElementById('redWhole').checked;
      const fd = new FormData(); if(file) fd.append('file', file);
      const url = `/api/text/redact?find=${encodeURIComponent(find)}&matchCase=${matchCase}&wholeWord=${wholeWord}`;
      const res = await fetch(url, { method:'POST', body: fd });
      await downloadFromResponse(res, 'text-redacted.pdf');
    }

    // ------- Drag & Drop Dropzones --------
    function makeDropzone(dzId, inputId, placeholderMany="PDFs hierher ziehen<br><small>oder klicken, um Dateien zu wÃ¤hlen</small>", placeholderOne="PDF hierher ziehen<br><small>oder klicken</small>"){
      const dz = document.getElementById(dzId);
      const inp = document.getElementById(inputId);
      const span = dz.querySelector('span');
      const isMulti = inp.hasAttribute('multiple');

      const setIdle = () => span.innerHTML = isMulti ? placeholderMany : placeholderOne;
      const update = () => {
        if (inp.files && inp.files.length) {
          span.textContent = inp.files.length === 1 ? inp.files[0].name : `${inp.files.length} Datei(en) ausgewÃ¤hlt`;
        } else setIdle();
      };

      ['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.add('drag'); }));
      ['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.remove('drag'); }));
      dz.addEventListener('drop', e => { inp.files = e.dataTransfer.files; update(); });
      inp.addEventListener('change', update);

      setIdle();
    }

    document.addEventListener('DOMContentLoaded', () => {
      makeDropzone('dz-merge','mergeFiles');
      makeDropzone('dz-split','splitFile');
      makeDropzone('dz-rot','rotFile');
      makeDropzone('dz-cmp','cmpFile');
      makeDropzone('dz-rep','repFile');
      makeDropzone('dz-red','redFile');
    });
  </script>
</body>
</html>
